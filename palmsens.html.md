# Palmsens Data Parsing


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

Let’s load a typical palmsens file

``` python
import os
```

``` python
test_dpvs_root = "../test_files/DPVs_palmsens"
os.listdir(test_dpvs_root)
```

    ['multi_column.csv', 'single_column.csv']

``` python
with open(os.path.join(test_dpvs_root, "multi_column.csv"), encoding="utf-16") as f: # note the utf-16 encoding
    lines = f.read().splitlines()

lines[:10]
```

    ['Date and time:,2025-03-29 23:18:59',
     'Notes:',
     ',,,,,,,,,,,,',
     'Differential Pulse Voltammetry [1]: S49,,Differential Pulse Voltammetry [8]: S48,,Differential Pulse Voltammetry [15]: S47,,Differential Pulse Voltammetry [22]: S46,,Differential Pulse Voltammetry [29]: S45,,Differential Pulse Voltammetry [36]: S44,,Differential Pulse Voltammetry [43]: S43',
     'Date and time measurement:,2025-03-29 13:32:13,Date and time measurement:,2025-03-29 14:28:03,Date and time measurement:,2025-03-29 16:28:02,Date and time measurement:,2025-03-29 17:28:20,Date and time measurement:,2025-03-29 19:41:19,Date and time measurement:,2025-03-29 20:35:10,Date and time measurement:,2025-03-29 21:22:52,',
     'V,µA,V,µA,V,µA,V,µA,V,µA,V,µA,V,µA',
     '0,0.019751112,0,0.040179824,0,0.045964596,0,0.04073982,0,0.044447004,0,0.043287808,0,0.05077498',
     '0.01020757,0.019157514,0.01020757,0.039586228,0.01020757,0.0450126,0.01020757,0.039709428,0.01020757,0.042632616,0.01020757,0.041630216,0.01020757,0.050198176',
     '0.02041514,0.018810318,0.02041514,0.038824632,0.02041514,0.044525404,0.02041514,0.039082228,0.02041514,0.04155182,0.02041514,0.040493424,0.02041514,0.047666992',
     '0.03062271,0.01848552,0.03062271,0.038460632,0.03062271,0.044407804,0.03062271,0.038936632,0.03062271,0.04089662,0.03062271,0.039731828,0.03062271,0.045947796']

palmsens files have a defined line by line format, so we can parse them
according to line index. first is the date and time (of export?). This
isn’t actually useful, the useful information is when the measurements
were taken, which is later

We don’t really use notes, so I’m also skipping lines 1 and 2. Next is
the names line:

``` python
lines[3]
```

    'Differential Pulse Voltammetry [1]: S49,,Differential Pulse Voltammetry [8]: S48,,Differential Pulse Voltammetry [15]: S47,,Differential Pulse Voltammetry [22]: S46,,Differential Pulse Voltammetry [29]: S45,,Differential Pulse Voltammetry [36]: S44,,Differential Pulse Voltammetry [43]: S43'

Now we need to parse datetimes for when the DPVs were taken

------------------------------------------------------------------------

<a
href="https://github.com/bxw315-umd/potentiostat-data-parser/blob/main/potentiostat_data_parser/chi.py#L14"
target="_blank" style="float:right; font-size:smaller">source</a>

### parse_datetime

>  parse_datetime (ps_datetime:str)

``` python
assert parse_datetime("2025-03-29 23:18:59") == datetime(2025, 3, 29, 23, 18, 59)
test_fail(lambda: parse_datetime("not a ps line"), exc=ValueError)
```

``` python
lines[4].split("Date and time measurement:,")[1:]
```

    ['2025-03-29 13:32:13,',
     '2025-03-29 14:28:03,',
     '2025-03-29 16:28:02,',
     '2025-03-29 17:28:20,',
     '2025-03-29 19:41:19,',
     '2025-03-29 20:35:10,',
     '2025-03-29 21:22:52,']

------------------------------------------------------------------------

<a
href="https://github.com/bxw315-umd/potentiostat-data-parser/blob/main/potentiostat_data_parser/palmsens.py#L19"
target="_blank" style="float:right; font-size:smaller">source</a>

### parse_measurement_datetimes

>  parse_measurement_datetimes (ps_fourth_line:str)

``` python
test(parse_measurement_datetimes(lines[4]), [datetime(2025, 3, 29, 13, 32, 13),
 datetime(2025, 3, 29, 14, 28, 3),
 datetime(2025, 3, 29, 16, 28, 2),
 datetime(2025, 3, 29, 17, 28, 20),
 datetime(2025, 3, 29, 19, 41, 19),
 datetime(2025, 3, 29, 20, 35, 10),
 datetime(2025, 3, 29, 21, 22, 52)], all_equal)
```

Next is the data, which is pairs of V, uA data

``` python
lines[5].split(",")
```

    ['V', 'µA', 'V', 'µA', 'V', 'µA', 'V', 'µA', 'V', 'µA', 'V', 'µA', 'V', 'µA']

------------------------------------------------------------------------

<a
href="https://github.com/bxw315-umd/potentiostat-data-parser/blob/main/potentiostat_data_parser/palmsens.py#L27"
target="_blank" style="float:right; font-size:smaller">source</a>

### validate_cols

>  validate_cols (ps_fifth_line:str)

<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 38%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>ps_fifth_line</td>
<td>str</td>
<td></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>bool</strong></td>
<td><strong>True if the file has the expected columns</strong></td>
</tr>
</tbody>
</table>

``` python
assert validate_cols(lines[5])
assert not validate_cols("not a valid col")
```

``` python
ps_data_lines = lines[6:-1] # the last line is always an end character
ps_data_lines[:5] # cols of V1, uA1, V2, uA2, V3, uA3, ...
```

    ['0,0.019751112,0,0.040179824,0,0.045964596,0,0.04073982,0,0.044447004,0,0.043287808,0,0.05077498',
     '0.01020757,0.019157514,0.01020757,0.039586228,0.01020757,0.0450126,0.01020757,0.039709428,0.01020757,0.042632616,0.01020757,0.041630216,0.01020757,0.050198176',
     '0.02041514,0.018810318,0.02041514,0.038824632,0.02041514,0.044525404,0.02041514,0.039082228,0.02041514,0.04155182,0.02041514,0.040493424,0.02041514,0.047666992',
     '0.03062271,0.01848552,0.03062271,0.038460632,0.03062271,0.044407804,0.03062271,0.038936632,0.03062271,0.04089662,0.03062271,0.039731828,0.03062271,0.045947796',
     '0.04083028,0.01798712,0.04083028,0.038225432,0.04083028,0.043971008,0.04083028,0.038634232,0.04083028,0.039759828,0.04083028,0.038651032,0.04083028,0.045707']

``` python
step1 = np.array([line.split(",") for line in ps_data_lines], dtype=float).T # first, lets transpose it. so now it's rows of V1, uA1, V2, uA2, V3, uA3, ...
step1[:, :5]
```

    array([[0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
           [0.01975111, 0.01915751, 0.01881032, 0.01848552, 0.01798712],
           [0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
           [0.04017982, 0.03958623, 0.03882463, 0.03846063, 0.03822543],
           [0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
           [0.0459646 , 0.0450126 , 0.0445254 , 0.0444078 , 0.04397101],
           [0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
           [0.04073982, 0.03970943, 0.03908223, 0.03893663, 0.03863423],
           [0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
           [0.044447  , 0.04263262, 0.04155182, 0.04089662, 0.03975983],
           [0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
           [0.04328781, 0.04163022, 0.04049342, 0.03973183, 0.03865103],
           [0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
           [0.05077498, 0.05019818, 0.04766699, 0.0459478 , 0.045707  ]])

``` python
step2 = step1.reshape(step1.shape[0]//2, 2, -1)
step2[:,:, :5]
```

    array([[[0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
            [0.01975111, 0.01915751, 0.01881032, 0.01848552, 0.01798712]],

           [[0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
            [0.04017982, 0.03958623, 0.03882463, 0.03846063, 0.03822543]],

           [[0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
            [0.0459646 , 0.0450126 , 0.0445254 , 0.0444078 , 0.04397101]],

           [[0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
            [0.04073982, 0.03970943, 0.03908223, 0.03893663, 0.03863423]],

           [[0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
            [0.044447  , 0.04263262, 0.04155182, 0.04089662, 0.03975983]],

           [[0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
            [0.04328781, 0.04163022, 0.04049342, 0.03973183, 0.03865103]],

           [[0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028],
            [0.05077498, 0.05019818, 0.04766699, 0.0459478 , 0.045707  ]]])

``` python
# and now, if i want to retrieve a specific column's data
col_data = step2[2, :, :5]
{
    "potential": col_data[0],
    "current": col_data[1]*1e-6 # to convert it from uA to A
}
```

    {'potential': array([0.        , 0.01020757, 0.02041514, 0.03062271, 0.04083028]),
     'current': array([4.5964596e-08, 4.5012600e-08, 4.4525404e-08, 4.4407804e-08,
            4.3971008e-08])}

------------------------------------------------------------------------

<a
href="https://github.com/bxw315-umd/potentiostat-data-parser/blob/main/potentiostat_data_parser/palmsens.py#L45"
target="_blank" style="float:right; font-size:smaller">source</a>

### retrieve_data

>  retrieve_data (col_index:int, organized_data:numpy.ndarray)

<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 38%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>col_index</td>
<td>int</td>
<td>index of the column</td>
</tr>
<tr>
<td>organized_data</td>
<td>ndarray</td>
<td>output of <a
href="https://bxw315-umd.github.io/potentiostat-data-parser/palmsens.html#organize_column_data"><code>organize_column_data</code></a></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>dict</strong></td>
<td><strong>a dict with potential (in volts) and current (in
A)</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/bxw315-umd/potentiostat-data-parser/blob/main/potentiostat_data_parser/palmsens.py#L38"
target="_blank" style="float:right; font-size:smaller">source</a>

### organize_column_data

>  organize_column_data (ps_data_lines:list[str])

<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 38%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>ps_data_lines</td>
<td>list</td>
<td>usually lines[6:-1] of a palmsens .csv file</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>ndarray</strong></td>
<td><strong>numpy array with shape (N, 2, L) where N is the number of
columns, the second axis is [potential, current], and L is length of
measurement</strong></td>
</tr>
</tbody>
</table>

Putting it all together,

------------------------------------------------------------------------

<a
href="https://github.com/bxw315-umd/potentiostat-data-parser/blob/main/potentiostat_data_parser/palmsens.py#L56"
target="_blank" style="float:right; font-size:smaller">source</a>

### parse_palmsens_file

>  parse_palmsens_file (contents:str)

\*Takes the contents of a Palmsens .csv file (usually encoded in utf-16)
and returns a list of measurements. For instance,

``` python
[
    {
        'name': 'Differential Pulse Voltammetry [1]: S49',
        'timestamp': '2025-03-29T13:32:13',
        'potential': array([0.        , 0.01020757, 0.02041514, 0.03062271, ...]),
        'current': array([1.97511120e-08, 1.91575140e-08, 1.88103180e-08, ...])
    },
    {
        'name': 'Differential Pulse Voltammetry [8]: S48',
        'timestamp': '2025-03-29T14:28:03',
        'potential': array([0.        , 0.01020757, 0.02041514, ... ]),
        'current': array([4.0179824e-08, 3.9586228e-08, 3.8824632e-08, ...])
    }
]```*


Now for a few tests:

::: {.cell}
``` {.python .cell-code}
with open(os.path.join(test_dpvs_root, "multi_column.csv"), encoding="utf-16") as f:
    contents = f.read()

output = parse_palmsens_file(contents)
assert output[0]["name"] == "Differential Pulse Voltammetry [1]: S49"
assert output[0]["timestamp"] == "2025-03-29T13:32:13"
assert len(output) == 7
assert output[3]["current"][-1] == 7.4046544e-08
```

:::

``` python
with open(os.path.join(test_dpvs_root, "single_column.csv"), encoding="utf-16") as f:
    contents = f.read()

output = parse_palmsens_file(contents)
assert len(output) == 1
assert output[0]["name"] == "Differential Pulse Voltammetry [1]: 31.25uM - DPV i vs E [1]"
assert output[0]["timestamp"] == "2025-02-11T16:04:12"
assert output[0]["potential"][2] == 0.02041514
assert output[0]["current"][0] == 3.4395052e-08
assert output[0]["current"][-1] == 7.5359048e-08
```
